/**
 * This ruleset enforces a strict, role-based access control (RBAC) model centered around administrators.
 *
 * Core Philosophy:
 * Admin status is determined by the existence of a document in the `/roles_admin` collection,
 * where the document ID matches the user's UID. This is a secure and performant approach.
 *
 * Key Security Decisions:
 * - Public vs. Private Data: Billboards are public-read, but writes are restricted to admins.
 *   Contact inquiries are publicly writable, but only readable by admins.
 * - Admin Self-Verification: Any authenticated user can check for their OWN admin document. This is
 *   required for the application to verify their status upon login.
 * - Admin Management: Only existing administrators can view the full list of admins or manage other admins.
 * - Default Deny: All access is denied by default and only explicitly granted through these rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    //-------------------------------------------------------------------------
    // Helper Functions
    //-------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user has an admin role.
     * This relies on the `get` permission being granted on the user's own
     * document in the `/roles_admin` collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    //-------------------------------------------------------------------------
    // Collection Rules
    //-------------------------------------------------------------------------

    /**
     * /billboards/{billboardId}
     * Publicly readable, but only admins can create, update, or delete.
     */
    match /billboards/{billboardId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * /roles_admin/{adminId}
     * This collection is the source of truth for admin privileges.
     * - `get`: Allows an authenticated user to read their OWN admin role document. This is critical for the app's auth flow.
     * - `list`, `write`: Allows an existing admin to manage other admin roles (view list, add, remove).
     */
    match /roles_admin/{adminId} {
      allow get: if isSignedIn() && request.auth.uid == adminId;
      allow list, write: if isAdmin();
    }

    /**
     * @description Defines rules for the 'admin_users' collection, which stores profile
     *              information for administrators. Only other admins can view or manage
     *              these user profiles.
     * @path        /admin_users/{adminUserId}
     * @allow       (get, list, create, update, delete) by a user who is already an admin.
     * @deny        Any access by non-admin users to protect admin information.
     * @principle   Protects sensitive user data and enforces relational integrity on create/update.
     */
    match /admin_users/{adminUserId} {
      allow get, list, create, update, delete: if isAdmin();
    }
    
    /**
     * /inquiries/{inquiryId}
     * Publicly writable for new inquiries, but only admins can read, update, or delete.
     */
    match /inquiries/{inquiryId} {
      allow create: if request.resource.data.name is string 
                    && request.resource.data.email is string
                    && request.resource.data.message is string
                    && request.time == request.resource.data.submittedAt;
      allow list: if isAdmin();
      allow get, update, delete: if isAdmin();
    }
  }
}
